var uploadedImageBase64=null,uploadedMaskBase64=null,expandImageBase64=null,expandMaskBase64=null,initialPosition=null,characterPrompts=[],v4_prompt_char_captions=[],v4_negative_prompt_char_captions=[],seedText=null,expand_width=0,expand_height=0;let imageIndex=0;var progress=0,attempt=0,defry=0,imagesBase64={},informationExtracted={},Reference_strength={},isProcessing=!1,augmentImageValue="";let previousValue="";var processedJobs=new Set,autoDownload=!1,autoVoice=!1,disabled_original_image=!1;let isKeydownListenerBound=!1;var draw_color_image=!1,sliderValues={"Scale-input":5,"Steps-input":28,"image-input":1,"Width-input":832,"Height-input":1216,"Content-Strength-input":1,"Rescale-input":0,"Strength-input":.7,"Noise-input":0};function convertObjectsToArrays(e,t,n){var o=[],a=[],i=[];for(var r in e)console.log(r),e.hasOwnProperty(r)&&(o.push(e[r]),a.push(t[r]),i.push(n[r]));return console.log(i),{images:o,informationExtracted:a,Reference_strength:i}}function getSliderValue(e){var t=localStorage.getItem(e);return null!==t?parseFloat(t):sliderValues[e]}function generateTOTP(e){const t=Math.floor((new Date).getTime()/1e3/60);return CryptoJS.SHA256(t+e).toString()}function updateQueuePosition(e){var t=document.getElementById("queue");null===initialPosition&&(initialPosition=e,progress=0),e>0?progress=Math.max(0,Math.min(90,(initialPosition-e)/initialPosition*100)):0===e&&progress<90&&(progress=90,updateProgressOverTime()),t?t.innerHTML='<a href="javascript:;">生成进度：'+progress.toFixed(0)+"%</a>":console.error("队列位置元素未找到"),progress>=100&&console.log("进度完成！")}function updateProgressOverTime(){var e=setInterval(function(){progress>=99?(clearInterval(e),progress=99):(progress+=.9,updateQueuePosition(0))},1e3)}function resetButtonState(){var e=document.getElementById("generate-images");e.disabled=!1,e.classList.remove("layui-btn-disabled"),e.textContent="Generate Images",window.attempt=0,clearQueuePosition(),autoVoice&&$.getJSON("/get_mp3_files",function(e){if(e.length>0){var t=e[Math.floor(Math.random()*e.length)];new Audio("/static/voice/"+t).play()}})}function collectParametersAndSendRequest(e,t){var n=$("input[name='Auto_random']").is(":checked"),o=$("input[name='Auto_polling']").is(":checked"),a=getSliderValue("image-input");if(t=a,n&&(document.getElementById("randomSelectBtn").click(),setTimeout(()=>{},10)),o&&(document.getElementById("getTerms").click(),setTimeout(()=>{},10)),e>=t)return console.log("已达到最大尝试次数"),void resetButtonState();var i=document.getElementById("generate-images");i.disabled=!0,i.classList.add("layui-btn-disabled"),i.textContent="生成中(将连续绘制更改为1取消连续绘制)";var r=document.querySelector("input[name='SMEA']").checked,l=document.querySelector("input[name='Decrisp']").checked,s=document.querySelector("input[name='Variety']").checked,c=document.getElementById("dyn-container"),u="none"!==c.style.display&&c.querySelector("input[name='DYN']").checked,d=document.querySelector("input[name='Vibe_Transfer']").checked,m=document.querySelector("input[name='AI_choice_Positions']").checked;var g,p=document.getElementById("tagarea").value.replace(/\/\*[\s\S]*?\*\//g,""),h=document.getElementById("seed");g=h.value?h.value:Math.floor(9e8*Math.random())+1e8,seedText=g.toString(),Window.isProcessing&&(_=1024,S=1024);var y=document.getElementById("tagarea2").value,f=getSliderValue("Scale-input"),v=getSliderValue("Steps-input"),S=768,_=1024;S=getSliderValue("Width-input"),_=getSliderValue("Height-input");var E=getSliderValue("Rescale-input"),I=getSliderValue("Strength-input"),b=getSliderValue("Noise-input"),w=document.getElementById("sampling-algorithm").value,x=document.getElementById("noise-schedule").value,k=document.getElementById("model-list").value,T=convertObjectsToArrays(imagesBase64,informationExtracted,Reference_strength);const B=generateTOTP("xianyun_2776359982_xianyun@idlecloud.cc_THIS_PROJECT_IS_PERSONALLY_CREATED_BY_XIANYUN_(QQ_NUMBER:_2776359982)_AND_IS_AVAILABLE_FOR_FREE_USE._IF_YOU_HAVE_PAID_FOR_THIS_PROJECT,_PLEASE_REQUEST_A_REFUND_AND_REPORT_THE_INCIDENT");var P=uploadedImageBase64,A=uploadedMaskBase64,R=expandImageBase64,L=expandMaskBase64,C=augmentImageValue,N={model:k,positivePrompt:p,negativePrompt:y,scale:f,steps:v,width:S,height:_,promptGuidanceRescale:E,noise_schedule:x,seed:seedText,sampler:w,sm:r,sm_dyn:u,decrisp:l,variety:s,pictureid:B,characterPrompts:characterPrompts,v4_prompt_char_captions:v4_prompt_char_captions,v4_negative_prompt_char_captions:v4_negative_prompt_char_captions,use_coords:!m,autoDownload:autoDownload};if(d&&(N.reference_image_multiple=T.images,N.reference_information_extracted_multiple=T.informationExtracted,N.reference_strength_multiple=T.Reference_strength),P&&(N.image=P,N.noise=b,N.strength=I,N.action=!0),A&&(N.mask=A,N.sm=!1,N.sm_dyn=!1,disabled_original_image&&(N.disabled_original_image=!0)),R&&L&&(N.noise=b,N.strength=I,N.action=!0,N.image=R,N.mask=L,N.width=expand_width,N.height=expand_height),C&&(N.req_type=C,"colorize"===C&&(N.defry=Number(document.getElementById("defryInput").value),N.prompt=document.getElementById("colorize_Prompt").value),"emotion"===C)){var V=document.querySelector('select[name="emotion"]').value,q=document.getElementById("emotion_Prompt").value;N.prompt=V+";; "+q,N.defry=window.defry}fetch("/api/generate_image",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(N)}).then(e=>e.json()).then(n=>{if(!n.job_id)throw new Error(n.error||"未知错误");updateQueuePosition(n.queue_position),pollForResult(n.job_id,e,t),e>=t&&(console.log("标志1"),resetButtonState())}).catch(n=>{e>=t?(resetButtonState(),alert(`请求失败: ${n}`)):(alert(`请求失败: ${n}`),collectParametersAndSendRequest(e+1,t))})}function pollForResult(e,t,n){t=window.attempt;var o=document.getElementById("userOpus");console.log(t),setTimeout(()=>{fetch("/api/get_result/"+e).then(e=>e.json()).then(a=>{if(processedJobs.has(e))clearQueuePosition();else if(void 0!==a.queue_position&&updateQueuePosition(a.queue_position),a.image_base64){window.attempt+=1,processedJobs.add(e),progress=a.progress;var i=document.getElementById("img-display"),r=document.createElement("img");r.style.maxWidth="100%",r.style.height="auto",r.src="data:image/png;base64,"+a.image_base64,i.innerHTML="",i.appendChild(r);var l=document.getElementById("img-preview"),s=document.createElement("div");s.title="点击预览图像,左右键切换图像",s.style.display="flex",s.style.flexDirection="column",s.style.alignItems="center",s.style.border="2px solid transparent",s.dataset.index=imageIndex,imageIndex++;var c=document.createElement("img");c.style.width="50px",c.style.height="50px",c.src=r.src;var u=document.createElement("span");u.textContent="Seed: "+seedText,u.style.display="block",u.style.marginTop="10px",u.style.textAlign="center",u.style.cursor="pointer";var d=document.createElement("button");function m(e){document.getElementById("img-preview").querySelectorAll("div").forEach(function(e){e.style.border="2px solid transparent"}),e.style.border="2px solid #16baaa"}d.textContent="Delete",d.classList.add("layui-btn","layui-btn-fluid","layui-btn-danger","layui-btn-xs"),d.style.marginBottom="10px",d.style.cursor="pointer",d.addEventListener("click",function(){l.removeChild(s);var e=l.querySelectorAll("div");e.length>0?updateDisplayArea(e[0].querySelector("img").src):i.innerHTML=""}),s.appendChild(c),s.appendChild(u),s.appendChild(d),l.firstChild?l.insertBefore(s,l.firstChild):l.appendChild(s),c.onclick=function(){updateDisplayArea(this.src),l.querySelectorAll("div").forEach(function(e){e.style.border="2px solid transparent"}),s.style.border="2px solid #16baaa"},isKeydownListenerBound||(document.addEventListener("keydown",function(e){var t=document.getElementById("img-preview").querySelectorAll("div");if(0===t.length)return void console.log("没有预览图像");for(var n=-1,o=0;o<t.length;o++)if("2px solid rgb(22, 186, 170)"===t[o].style.border){n=o;break}if(-1===n)return void console.log("没有选中的图像容器");document.addEventListener("keydown",function(e){var o="INPUT"===e.target.tagName||"TEXTAREA"===e.target.tagName||e.target.isContentEditable;if(!o)if("ArrowRight"===e.key){if(console.log("向右切换到下一个图像"),n<t.length-1){var a=t[n+1];m(a),updateDisplayArea(a.querySelector("img").src)}}else if("ArrowLeft"===e.key&&(console.log("向左切换到上一个图像"),n>0)){var i=t[n-1];m(i),updateDisplayArea(i.querySelector("img").src)}})}),isKeydownListenerBound=!0),function(e){u.onclick=function(){updateSeedInput(e)}}(seedText),void 0!==a.remaining_opus&&(o.innerHTML="Opus: "+a.remaining_opus),window.isProcessing&&("function"==typeof processImage?processImage():console.error("未定义的错误")),clearQueuePosition(),window.attempt<n&&collectParametersAndSendRequest(t=window.attempt,n),window.attempt>=n&&(console.log("标志2"),resetButtonState())}else if(!a.status||"processing"!==a.status&&"queued"!==a.status){if(a.error)throw window.attempt+=1,new Error(a.error)}else console.log("排队中，等待结果..."),t=window.attempt,pollForResult(e,t,n)}).catch(e=>{console.error("轮询结果出错:",e),window.attempt+=1,(t=window.attempt)>=n&&(console.log("标志3"),resetButtonState(),alert(`请求失败: ${e}`)),t<n&&collectParametersAndSendRequest(t,n)})},2e3)}function clearQueuePosition(){var e=document.getElementById("queue");e&&(e.innerHTML="")}function updateDisplayArea(e){var t=document.getElementById("img-display");t.innerHTML="";var n=document.createElement("img");n.src=e,n.style.maxWidth="100%",n.style.height="auto",t.appendChild(n)}function updateSeedInput(e){if(window.confirm("你确定要更新种子值吗？")){var t=document.getElementById("seed");t&&(t.value=e)}}function setupTextareaMonitor(){let e=document.getElementById("tagarea"),t=null,n=0;function o(){let t=function(e,t){let n=[",","{","}","(",")","[","]","\n"],o=0;for(let a=t-1;a>=0;a--)if(n.includes(e[a])){o=a+1;break}return e.substring(o,t).trim()}(e.value,n);if(t){let o=`/novelai/suggest-tags?prompt=${encodeURIComponent(t)}`;fetch(o).then(e=>e.json()).then(o=>{console.log("Tags:",o.tags),function(t,o){const a=document.getElementById("tag-suggestions");a.innerHTML="",t.forEach(t=>{let i=document.createElement("span");i.textContent=t.tag_name,i.style.cssText="display: inline-block; border: 1px solid #d9d9d9; border-radius: 8px; padding: 5px 10px; margin-right: 10px; margin-bottom: 10px; cursor: pointer;",i.onclick=function(){let i=e.value.substring(0,n-o.length)+t.tag_name+e.value.substring(n);e.value=i,a.innerHTML=""},a.appendChild(i)})}(o.tags,t)}).catch(e=>console.error("Error fetching tags:",e))}}e.addEventListener("input",e=>{clearTimeout(t),n=e.target.selectionStart,t=setTimeout(()=>o(),600)})}function translateText(){let e=document.getElementById("translatearea1").value;if(!e.trim())return void alert("请输入需要翻译的内容");let t;if(e=e.replace(/，/g,",").replace(/。/g,".").replace(/！/g,"!").replace(/[{}()\/\\|\[\]]/g,""),/[\u4e00-\u9fa5]/.test(e)){if(t=300,e.length>t)return void alert("输入的中文内容不要超过300个字符")}else if(t=1800,e.length>t)return void alert("输入的英文内容不要超过1800字符");var n=layer.load(2,{shade:[.1,"#fff"]});fetch("/api/translate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e})}).then(e=>{if(!e.ok)throw new Error("Network response was not ok");return e.json()}).then(e=>{let t=e.translated_text.replace(/[‘“"’”]/g,"");document.getElementById("translatearea2").value=t}).catch(e=>{console.error("Error:",e),alert("翻译失败，请稍后再试。")}).finally(()=>{layer.close(n)})}function base64ToFile(e,t){const n=atob(e.split(",")[1]),o=e.split(",")[0].split(":")[1].split(";")[0],a=new ArrayBuffer(n.length),i=new Uint8Array(a);for(let e=0;e<n.length;e++)i[e]=n.charCodeAt(e);const r=new Blob([a],{type:o});return new File([r],t,{type:o})}function updateStatusText(){var e=document.getElementById("statusText");switch(defry){case 0:e.textContent="Normal";break;case 1:e.textContent="Slightly Weak";break;case 2:e.textContent="Weak";break;case 3:e.textContent="Even Weaker";break;case 4:e.textContent="Very Weak";break;case 5:e.textContent="Weakest"}}layui.use("slider",function(){var e=layui.slider;function t(e,t){var n,o=e.replace("#","");n="Scale-input"===o||"Rescale-input"===o||"Strength-input"===o||"Noise-input"===o?t/50:t,localStorage.setItem(o,n)}window.Scale_input=e.render({elem:"#Scale-input",tips:!1,min:0,max:500,step:1,value:50*localStorage.getItem("Scale-input")||250,change:function(e){t("#Scale-input",e),document.getElementById("Scale-value").innerText=(e/50).toFixed(1)}}),null!==localStorage.getItem("Scale-input")?document.getElementById("Scale-value").innerText=parseFloat(localStorage.getItem("Scale-input")).toFixed(1):document.getElementById("Scale-value").innerText="5.0",window.Steps_input=e.render({elem:"#Steps-input",input:!0,min:1,max:50,value:localStorage.getItem("Steps-input")||28,change:function(e){t("#Steps-input",e)}}),window.image_input=e.render({elem:"#image-input",input:!0,min:1,max:500,value:localStorage.getItem("image-input")||1,change:function(e){t("#image-input",e)}});var n=localStorage.getItem("Height-input")||512;function o(o){var a=function(e){for(var t=512,n=512,o=Number.MAX_SAFE_INTEGER,a=512;a<=4096;a+=64){var i=a*e;if(i>=3063808&&i<=3145728)t=a;else if(i<3063808){var r=3063808-i;r<o&&(n=a,o=r)}}return 512!==t?t:n}(o),i=Math.min(n,a);t("#Height-input",i),window.Height_input=e.render({elem:"#Height-input",input:!0,min:512,max:a,value:i,step:64,showstep:!0,change:function(e){localStorage.setItem("Height-input",e),n=e}})}window.Width_input=e.render({elem:"#Width-input",input:!0,min:512,max:4096,value:localStorage.getItem("Width-input")||1024,step:64,showstep:!0,change:function(e){o(e),localStorage.setItem("Width-input",e)}}),window.updateSlidersWithImageSize=function(){if(imageSize[0]>=512&&imageSize[0]<=2048&&imageSize[1]>=512&&imageSize[1]<=2048){var e=512+(imageSize[0]-512)/64;window.Width_input.setValue(e),localStorage.setItem("Width-input",imageSize[0]);var t=512+(imageSize[1]-512)/64;window.Height_input.setValue(t),localStorage.setItem("Height-input",imageSize[1])}},o(localStorage.getItem("Width-input")||1024),window.Rescale_input=e.render({elem:"#Rescale-input",tips:!1,min:0,max:50,step:1,value:50*localStorage.getItem("Rescale-input")||0,change:function(e){t("#Rescale-input",e),document.getElementById("Rescale-value").innerText=(e/50).toFixed(2)}}),null!==localStorage.getItem("Rescale-input")?document.getElementById("Rescale-value").innerText=parseFloat(localStorage.getItem("Rescale-input")).toFixed(2):document.getElementById("Rescale-value").innerText="0.00",window.Strength_input=e.render({elem:"#Strength-input",tips:!1,min:0,max:50,step:1,value:50*localStorage.getItem("Strength-input")||35,change:function(e){t("#Strength-input",e),document.getElementById("Strength-value").innerText=(e/50).toFixed(2)}}),null!==localStorage.getItem("Strength-input")?document.getElementById("Strength-value").innerText=parseFloat(localStorage.getItem("Strength-input")).toFixed(2):document.getElementById("Strength-value").innerText="0.70",window.Noise_input=e.render({elem:"#Noise-input",tips:!1,min:0,max:50,step:1,value:50*localStorage.getItem("Noise-input")||0,change:function(e){t("#Noise-input",e),document.getElementById("Noise-value").innerText=(e/50).toFixed(2)}}),null!==localStorage.getItem("Noise-input")?document.getElementById("Noise-value").innerText=parseFloat(localStorage.getItem("Noise-input")).toFixed(2):document.getElementById("Noise-value").innerText="0.00"}),document.addEventListener("DOMContentLoaded",e=>{document.getElementById("github").addEventListener("click",function(){window.open("https://github.com/YILING0013","_blank")}),document.getElementById("bilibili").addEventListener("click",function(){window.open("https://space.bilibili.com/487156342","_blank")}),document.getElementById("afdian").addEventListener("click",function(){window.open("https://afdian.com/a/lingyunfei","_blank")})}),layui.use(["form","jquery"],function(){var e=layui.form,t=layui.jquery;t(".slider-container").hide(),t(".Vibe-container").hide(),e.on("checkbox(smea-checkbox)",function(e){var n=e.elem.checked?"inline-block":"none";t("#dyn-container").css("display",n)})}),document.getElementById("generate-images").addEventListener("click",function(){collectParametersAndSendRequest(0,getSliderValue("image-input"))}),layui.use(function(){var e=layui.form,t=layui.layer;e.on("checkbox(autoDownload)",function(e){1==e.elem.checked?(autoDownload=!0,console.log("自动下载已启用")):(autoDownload=!1,console.log("自动下载已禁用"))}),e.on("checkbox(autoVoice)",function(e){1==e.elem.checked?(autoVoice=!0,console.log("自动语音播放已启用")):(autoVoice=!1,console.log("自动语音播放已禁用"))}),e.on("checkbox(disabled_original_image)",function(e){1==e.elem.checked?(disabled_original_image=!0,console.log("禁用原图已启用")):(disabled_original_image=!1,console.log("禁用原图已禁用"))}),e.on("checkbox(draw_color_image)",function(e){1==e.elem.checked?(draw_color_image=!0,console.log("绘制彩色图像已启用")):(draw_color_image=!1,console.log("绘制彩色图像已禁用"))}),e.on("radio(augment-image)",function(n){const o=n.value;o===previousValue?(document.querySelectorAll('input[name="augment-image"]').forEach(e=>{e.checked=!1}),t.msg("取消选中"),augmentImageValue="",previousValue="",e.render("radio")):(augmentImageValue=o,t.msg("value: "+augmentImageValue+", checked: "+n.elem.checked),previousValue=o),document.getElementById("emotionContent").style.display="emotion"===augmentImageValue?"block":"none",document.getElementById("colorizeContent").style.display="colorize"===augmentImageValue?"block":"none"})}),window.addEventListener("load",setupTextareaMonitor),layui.use(["layer"],function(){var e=layui.layer;document.getElementById("img-display").addEventListener("click",function(){e.open({type:1,title:"操作图片",content:'<div style="padding: 20px;"><button class="layui-btn" id="upload-btn">上传到图床</button><button class="layui-btn" id="save-btn">保存到本地</button></div>',success:async function(t,n){var o=document.getElementById("upload-btn"),a=document.getElementById("save-btn");o.addEventListener("click",async function(){o.disabled=!0,o.classList.add("layui-btn-disabled");var t=base64ToFile(document.querySelector("#img-display img").src,"image.png"),a=new FormData;a.append("image",t);try{const t=await fetch("/api/upload",{method:"POST",body:a});if(!t.ok)throw 401===t.status?"unauthorized":new Error("Network response was not ok.");{const o=await t.json();console.log(o),e.msg("图片上传成功,你可以在图床内查看你的图像了",{icon:1}),e.close(n)}}catch(t){"unauthorized"===t?(e.prompt({formType:1,value:"",title:"请输入Token"},function(t,o){a.append("token",t),fetch("/api/upload",{method:"POST",body:a}).then(e.close(o)).then(e=>e.json()).then(t=>{console.log(t),e.msg("图片上传成功,你可以在图床内查看你的图像了",{icon:1}),e.close(o),e.close(n)}).catch(t=>{console.error("There has been a problem with your fetch operation:",t),e.msg("上传失败",{icon:2}),e.close(o),e.close(n)})}),e.alert('请按照以下步骤获取Token：<br>1. 访问 <a href="https://imgtp.com/" target="_blank">https://imgtp.com/</a> 并注册账号。<br>2. 注册并登录后，进入到用户设置中找到API Token。<br>3. 复制并返回此处粘贴Token。<br>4. 如果需要修改token或者删除token，点击user，然后点击删除token。',{title:"获取Token教程"})):(console.error("There has been a problem with your fetch operation:",t),e.msg("上传失败",{icon:2}),e.close(n))}finally{o.disabled=!1,o.classList.remove("layui-btn-disabled")}}),a.addEventListener("click",function(){a.disabled=!0;var t=document.querySelector("#img-display img").src,o=Math.random().toString(36).substring(2,18),i=document.createElement("a");i.href=t,i.download=o+".png",document.body.appendChild(i),i.click(),document.body.removeChild(i),e.close(n),a.disabled=!1})}})})}),layui.use(["layer"],function(){var e=layui.layer;document.getElementById("prompt_upload").addEventListener("click",function(){e.prompt({formType:0,value:"",title:"请输入文本标题",success:function(e){e.find(".layui-layer-input").attr("maxlength",10)}},function(t,n,o){var a=t,i=document.getElementById("tagarea").value,r=document.getElementById("tagarea2").value;fetch("/api/save_texts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:a,text_content1:i,text_content2:r})}).then(e=>e.json()).then(t=>{console.log("Success:",t),e.close(n),e.msg("上传成功,你可以在词条笔记本中查看你的词条了",{icon:1})}).catch(t=>{console.error("Error:",t),e.msg("上传失败")})})})}),layui.use(["form"],function(){layui.form.on("submit(formDemo)",function(e){return layer.msg(JSON.stringify(e.field)),!1})}),document.getElementById("decrementBtn").addEventListener("click",function(){defry>0&&(defry--,updateStatusText())}),document.getElementById("incrementBtn").addEventListener("click",function(){defry<5&&(defry++,updateStatusText())}),updateStatusText();