let cropper,dx=0,dy=0;var uploadSource="",imageSize=[0,0];let colorPickerInstance,isEraserMode=!1;var drawColor=null;function processImage(){const e=document.getElementById("img-display"),t=e.querySelector("img");if(!t)return void alert("请先在指定区域加载一个图像！");const n=t.src;if(n&&cropper){const t=new Image;t.onload=function(){const a=cropper.getCropBoxData(),i=cropper.getImageData(),d=document.createElement("canvas"),o=d.getContext("2d");d.width=i.naturalWidth,d.height=i.naturalHeight;const l=document.getElementById("Pro-draw-image");o.drawImage(l,0,0,d.width,d.height);const r=Math.floor(a.naturalWidth),c=Math.floor(a.naturalHeight);o.drawImage(t,dx,dy,r,c);const s=d.toDataURL("image/png");e.innerHTML="";var h=document.createElement("img");h.src=s,h.style.maxWidth="100%",h.style.height="auto",e.appendChild(h),updatePreviewArea(n,s)},t.src=n}else alert("请先上传一个图像文件，并确保cropper已初始化！")}function updatePreviewArea(e,t){var n=document.getElementById("img-preview");n?n.querySelectorAll("div").forEach(function(n){var a=n.querySelector("img");a&&a.src===e&&(a.src=t)}):console.error("预览区域未找到，请确保预览区域存在。")}function displayMask(e){let t=document.getElementById("mask-preview");t.innerHTML="";let n=new Image;n.onload=function(){let e=document.createElement("canvas");e.width=n.width,e.height=n.height;let a=e.getContext("2d");a.drawImage(n,0,0);let i=a.getImageData(0,0,e.width,e.height),d=i.data;for(let e=0;e<d.length;e+=4)d[e]=255-d[e],d[e+1]=255-d[e+1],d[e+2]=255-d[e+2];a.putImageData(i,0,0);let o=new Image;o.src=e.toDataURL(),uploadedMaskBase64=o.src.split(",")[1],o.style.width="50px",o.style.height="50px",t.appendChild(o)},n.src=e}document.getElementById("eraserBtn").addEventListener("click",function(){isEraserMode=!isEraserMode,this.textContent=isEraserMode?"切换到画笔":"切换到橡皮擦"}),layui.use(["upload","jquery"],function(){var e=layui.upload,t=layui.colorpicker,n=layui.jquery;n(".slider-container").hide();let a=[],i=[],d=!1;function o(){i=[],a.push({mask:c.toDataURL(),color:h.toDataURL()})}function l(){s.clearRect(0,0,c.width,c.height),u.clearRect(0,0,h.width,h.height),a=[{mask:c.toDataURL(),color:h.toDataURL()}],i=[],document.getElementById("mask-preview").innerHTML=""}let r=document.getElementById("imageCanvas"),c=document.getElementById("maskCanvas"),s=c.getContext("2d"),h=document.getElementById("colorCanvas"),u=h.getContext("2d"),g=document.getElementById("brushSize"),m=document.getElementById("exportMask"),p=document.getElementById("exportColorBtn"),w=0,f=0;function y(){var e=r.getBoundingClientRect();c.style.width=e.width+"px",c.style.height=e.height+"px",c.width=e.width,c.height=e.height,c.style.position="absolute",c.style.left=r.offsetLeft+"px",c.style.top=r.offsetTop+"px",h.style.width=e.width+"px",h.style.height=e.height+"px",h.width=e.width,h.height=e.height,h.style.position="absolute",h.style.left=r.offsetLeft+"px",h.style.top=r.offsetTop+"px",n(".canvas-container").css("height",e.height+"px")}function v(){y(),window.addEventListener("resize",y),l()}function I(e){if(!d)return;let t,n;e.touches?(t=e.touches[0].clientX-(draw_color_image?h:c).getBoundingClientRect().left,n=e.touches[0].clientY-(draw_color_image?h:c).getBoundingClientRect().top,e.preventDefault()):(t=e.offsetX,n=e.offsetY);let a=draw_color_image?u:s;isEraserMode?(a.globalCompositeOperation="destination-out",a.strokeStyle="rgba(0,0,0,1)"):(a.globalCompositeOperation="source-over",draw_color_image?a.strokeStyle=drawColor:a.strokeStyle="rgba(17,153,238,1)"),a.lineWidth=g.value,a.lineJoin="round",a.lineCap="round",a.beginPath(),a.moveTo(w,f),a.lineTo(t,n),a.stroke(),[w,f]=[t,n]}c.addEventListener("mousedown",e=>{d=!0,[w,f]=[e.offsetX,e.offsetY]}),c.addEventListener("mousemove",I),c.addEventListener("mouseup",()=>{d&&(o(),d=!1)}),c.addEventListener("mouseout",()=>{d&&(o(),d=!1)}),h.addEventListener("mousedown",e=>{d=!0,[w,f]=[e.offsetX,e.offsetY]}),h.addEventListener("mousemove",I),h.addEventListener("mouseup",()=>{d&&(o(),d=!1)}),h.addEventListener("mouseout",()=>{d&&(o(),d=!1)}),c.addEventListener("touchstart",e=>{d=!0;let t=e.touches[0];[w,f]=[t.clientX-c.getBoundingClientRect().left,t.clientY-c.getBoundingClientRect().top]}),c.addEventListener("touchmove",I),c.addEventListener("touchend",()=>{d&&(o(),d=!1)}),c.addEventListener("touchcancel",()=>{d&&(o(),d=!1)}),window.onload=(()=>{o(),y(),window.addEventListener("resize",y)}),m.addEventListener("click",function(){let e=document.createElement("canvas");e.width=r.width,e.height=r.height;let t=e.getContext("2d");t.drawImage(c,0,0,c.width,c.height,0,0,e.width,e.height);let n=t.getImageData(0,0,e.width,e.height),a=n.data;const i={r:17,g:153,b:238};for(let e=0;e<a.length;e+=4){const t=a[e],n=a[e+1],d=a[e+2],o=a[e+3],l=Math.sqrt(Math.pow(t-i.r,2)+Math.pow(n-i.g,2)+Math.pow(d-i.b,2));l<50?(a[e]=255,a[e+1]=255,a[e+2]=255,o<255&&(a[e+3]=255)):0===o&&(a[e]=0,a[e+1]=0,a[e+2]=0,a[e+3]=255)}t.putImageData(n,0,0);let d=e.toDataURL("image/png"),o=d.split(",")[1];uploadedMaskBase64=o;let l=document.getElementById("mask-preview");l.innerHTML="";let s=new Image;s.src=d,s.style.width="50px",s.style.height="50px",l.appendChild(s)}),p.addEventListener("click",function(){let e=document.createElement("canvas");e.width=r.width,e.height=r.height;let t=e.getContext("2d");t.drawImage(r,0,0,r.width,r.height);let n=document.createElement("canvas");n.width=r.width,n.height=r.height,n.getContext("2d").drawImage(h,0,0,h.width,h.height,0,0,n.width,n.height),t.drawImage(n,0,0);let a=e.toDataURL("image/png").split(",")[1];uploadedImageBase64=a});let x,E=!1;colorPickerInstance=t.render({elem:"#ID-colorpicker-demo-size-sm",color:"rgba(0,0,0,1)",alpha:!0,format:"rgb",size:"sm",done:function(e){drawColor=e}}),document.getElementById("colorPickerBtn").addEventListener("click",function(e){(E=!E)?(this.textContent="退出取色工具",(x=document.createElement("div")).style.width="50px",x.style.height="50px",x.style.border="1px solid #000",x.style.position="absolute",x.style.pointerEvents="none",x.style.zIndex="1000",document.body.appendChild(x),x.style.left=`${e.pageX+10}px`,x.style.top=`${e.pageY+10}px`):(this.textContent="取色工具",x&&(document.body.removeChild(x),x=null))}),c.addEventListener("mousemove",function(e){if(!E||!x)return;let t=r.getBoundingClientRect(),n=e.offsetX*r.width/t.width,a=e.offsetY*r.height/t.height,i=r.getContext("2d").getImageData(n,a,1,1).data,d=`rgb(${i[0]}, ${i[1]}, ${i[2]})`;x.style.backgroundColor=d,x.style.left=`${e.pageX+10}px`,x.style.top=`${e.pageY+10}px`}),c.addEventListener("click",function(e){if(!E||!x)return;let n=r.getBoundingClientRect(),a=e.offsetX*r.width/n.width,i=e.offsetY*r.height/n.height,d=r.getContext("2d").getImageData(a,i,1,1).data,o=`rgb(${d[0]}, ${d[1]}, ${d[2]})`;drawColor=o,t.render({elem:"#ID-colorpicker-demo-size-sm",color:o,alpha:!0,format:"rgb",size:"sm",done:function(e){drawColor=e}}),e.stopPropagation(),E=!1,document.getElementById("colorPickerBtn").textContent="取色工具",x&&(document.body.removeChild(x),x=null)});e.render({elem:"#ID-upload-demo-drag",auto:!1,choose:function(e){uploadSource="Instance1",n("#mask-draw-container").removeClass("layui-col-md6").addClass("layui-col-md12"),e.preview(function(e,t,a){layer.confirm("是否读取图像元数据到参数？(含seed)",{btn:["是","否"]},function(e){!function(e){const t=new FileReader;t.onload=function(e){const t=new Uint8Array(e.target.result),a=function(e){function t(t){if(t>=e.length)return null;const n=new DataView(e.buffer,t,4).getUint32(0),a=new TextDecoder("ascii").decode(e.slice(t+4,t+8)),i=e.slice(t+8,t+8+n),d=e.slice(t+8+n,t+12+n);return{length:n,chunkType:a,chunkData:i,crc:d,nextOffset:t+12+n}}const n=[];let a=8;for(;a<e.length;){const e=t(a);if(!e||!e.chunkType)break;if("tEXt"===e.chunkType||"iTXt"===e.chunkType){const t=new TextDecoder("utf-8").decode(e.chunkData);n.push({type:e.chunkType,text:t})}a=e.nextOffset}return n}(t),i=function(e){for(const t of e)if("tEXt"===t.type&&t.text.startsWith("Comment"))try{const e=t.text.split("\0")[1],n=JSON.parse(e);return n}catch(e){console.error("Failed to parse Comment chunk",e)}return null}(a);i.prompt&&n("#tagarea").val(i.prompt),i.uc&&n("#tagarea2").val(i.uc),i.seed&&n("#seed").val(i.seed),i.scale&&(window.Scale_input.setValue(50*i.scale),document.getElementById("Scale-value").innerText=i.scale.toFixed(2)),i.steps<=28&&window.Steps_input.setValue(i.steps),i.cfg_rescale&&(window.Rescale_input.setValue(50*i.cfg_rescale),document.getElementById("Rescale-value").innerText=i.cfg_rescale.toFixed(2)),i.uncond_scale&&(window.Content_Strength_input.setValue(50*i.uncond_scale),document.getElementById("Content-Strength-value").innerText=i.uncond_scale.toFixed(2)),i.strength&&(window.Strength_input.setValue(50*i.strength),document.getElementById("Strength-value").innerText=i.strength.toFixed(2)),i.noise?(window.Noise_input.setValue(50*i.noise),document.getElementById("Noise-value").innerText=i.noise.toFixed(2)):window.Noise_input.setValue(0)},t.readAsArrayBuffer(e)}(t),layer.close(e),C(a)},function(e){layer.close(e),C(a)})})},done:function(e,t,n){this.item.val("")}});function C(e){var t=new Image;t.onload=function(){var e=t.width,a=t.height,i=Math.min(1048576/(e*a),1);for(e=Math.round(e*i),a=Math.round(a*i),e+=(64-e%64)%64,a+=(64-a%64)%64;e*a>1048576;)i=Math.min(1048576/(e*a),1),e=Math.round(t.width*i),a=Math.round(t.height*i),e+=(64-e%64)%64,a+=(64-a%64)%64;for(;(e+64)*(a+64)<=1048576;)e+=64,a+=64;imageSize=[e,a],updateSlidersWithImageSize();var d=document.getElementById("imageCanvas"),o=d.getContext("2d");d.width=e,d.height=a,o.drawImage(t,0,0,e,a);var l=d.toDataURL("image/png").split(",")[1];uploadedImageBase64=l,n("#ID-upload-demo-preview").removeClass("layui-hide"),n("#ID-upload-demo-drag").addClass("layui-hide"),n("#Pro-upload-picture-drag").addClass("layui-hide"),n("#expand-picture-drag").addClass("layui-hide"),n(".slider-container").show(),n("#delete-image-btn").show(),v(),n("#mask-draw").show();var r=document.getElementById("imageSize");r&&(r.textContent=e+" x "+a),s.clearRect(0,0,c.width,c.height),c.style.opacity="0.5"},t.src=e}document.getElementById("exportBtn").addEventListener("click",function(){cropper&&cropper.getCroppedCanvas({fillColor:"#FFFFFF"}).toBlob(function(e){const t=URL.createObjectURL(e);var a,i,d=new FileReader;d.readAsDataURL(e),d.onload=function(e){uploadedImageBase64=e.target.result.split(",")[1]},a=t,(i=new Image).onload=function(){n("#ID-upload-demo-preview").removeClass("layui-hide"),n(".slider-container").show(),n("#delete-image-btn").show(),n("#mask-draw").show();var e=document.getElementById("imageCanvas"),t=e.getContext("2d");e.width=i.width,e.height=i.height,t.drawImage(i,0,0,i.width,i.height),URL.revokeObjectURL(a),v()},i.src=a})});e.render({elem:"#Pro-upload-picture-drag",auto:!1,accept:"images",choose:function(e){uploadSource="Instance2",e.preview(function(e,t,a){n("#Pro-upload-picture-drag").addClass("layui-hide"),n("#ID-upload-demo-drag").addClass("layui-hide"),n("#expand-picture-drag").addClass("layui-hide"),window.isProcessing=!0;const i=document.getElementById("Pro-draw-image");i.src=a,i.style.display="block",n("#Pro-draw").show(),cropper&&cropper.destroy(),cropper=new Cropper(i,{aspectRatio:1,background:!0,center:!0,viewMode:1,zoomable:!0,scalable:!0,wheelZoomRatio:.1,movable:!0,dragMode:"move",crop(e){dx=Math.floor(e.detail.x),dy=Math.floor(e.detail.y)}})})},error:function(){}});n("#clear-all-Btn").click(function(e){e.stopPropagation();var t=document.getElementById("imageCanvas");t.getContext("2d").clearRect(0,0,t.width,t.height),cropper&&(cropper.destroy(),cropper=null),uploadSource="";const a=document.getElementById("Pro-draw-image");a&&(a.src="",a.style.display="none"),n(".slider-container").hide(),n("#ID-upload-demo-preview").addClass("layui-hide"),n("#ID-upload-demo-drag").removeClass("layui-hide"),n("#Pro-upload-picture-drag").removeClass("layui-hide"),n("#expand-picture-drag").removeClass("layui-hide"),document.getElementById("mask-preview").innerHTML="",n("#mask-draw").hide(),n("#Pro-draw").hide(),n("#ID-upload-demo-drag").next('input[type="file"]').val(""),n("#Pro-upload-picture-drag").next('input[type="file"]').val(""),uploadedImageBase64=null,uploadedMaskBase64=null,window.isProcessing=!1}),document.getElementById("undoBtn").addEventListener("click",function(){if(a.length>1){i.push(a.pop());let e=a[a.length-1],t=new Image;t.onload=function(){s.clearRect(0,0,c.width,c.height),s.drawImage(t,0,0)},t.src=e.mask;let n=new Image;n.onload=function(){u.clearRect(0,0,h.width,h.height),u.drawImage(n,0,0)},n.src=e.color}}),document.getElementById("redoBtn").addEventListener("click",function(){if(i.length>0){let e=i.pop();a.push(e);let t=new Image;t.onload=function(){s.clearRect(0,0,c.width,c.height),s.drawImage(t,0,0)},t.src=e.mask;let n=new Image;n.onload=function(){u.clearRect(0,0,h.width,h.height),u.drawImage(n,0,0)},n.src=e.color}}),document.getElementById("clearBtn").addEventListener("click",l),n("#delete-image-btn").click(function(e){e.stopPropagation();var t=document.getElementById("imageCanvas");t.getContext("2d").clearRect(0,0,t.width,t.height),n(".slider-container").hide(),n(this).hide(),n("#ID-upload-demo-preview").addClass("layui-hide"),"Instance1"==uploadSource&&(n("#ID-upload-demo-drag").removeClass("layui-hide"),n("#Pro-upload-picture-drag").removeClass("layui-hide"),n("#expand-picture-drag").removeClass("layui-hide")),document.getElementById("mask-preview").innerHTML="",n("#mask-draw").hide(),n("#ID-upload-demo-drag").next('input[type="file"]').val(""),n("#mask-draw-container").removeClass("layui-col-md12").addClass("layui-col-md6"),uploadedImageBase64=null,uploadedMaskBase64=null,augmentImageValue=null,document.querySelectorAll('input[name="augment-image"]').forEach(e=>{e.checked=!1}),previousValue="",layui.form.render("radio"),imageSize=[0,0]})}),layui.use(["upload","jquery"],function(){var e=layui.jquery,t=layui.upload;layui.layer;e(".Vibe-Transfer-container").hide();t.render({elem:"#upload-vibe",url:"",auto:!1,choose:function(t){t.preview(function(t,n,a){var i=new Image;i.src=a,i.onload=function(){var t=document.createElement("canvas"),n=t.getContext("2d");t.width=448,t.height=448;var a=i.width,d=i.height,o=Math.min(448/a,448/d),l=(448-a*o)/2,r=(448-d*o)/2;n.fillStyle="#000",n.fillRect(0,0,448,448),n.drawImage(i,l,r,a*o,d*o);var c=t.toDataURL(),s=c.split(",")[1],h="img-"+Date.now();imagesBase64[h]=s,informationExtracted[h]=1,Reference_strength[h]=.6,e(".Vibe-Transfer-container").show();var u=`\n\t\t\t\t\t\t<div id="${h}" style="display: flex;align-items: center;gap: 15px;">\n\t\t\t\t\t\t\t<div style="width: 100px;">\n\t\t\t\t\t\t\t\t<img class="layui-upload-img" src="${c}" style="width: 100%; height: 80px;">\n\t\t\t\t\t\t\t\t<div><a class="layui-btn layui-btn-xs layui-btn-fluid demo-delete" data-id="${h}">删除</a></div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div style="width: 95%;">\n\t\t\t\t\t\t\t\t<div class="control-container">\n\t\t\t\t\t\t\t\t\t<label for="slider-${h}" class="control-label">Information Extracted:</label>\n\t\t\t\t\t\t\t\t\t<input type="range" id="slider-${h}" name="slider-${h}" min="0" max="50" value="50" style="flex-grow: 1;">\n\t\t\t\t\t\t\t\t\t<span id="slider-value-${h}">1.00</span>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<hr class="ws-space-16">\n\t\t\t\t\t\t\t\t<div class="control-container">\n\t\t\t\t\t\t\t\t\t<label for="Reference-Strength-${h}" class="control-label">Reference Strength:</label>\n\t\t\t\t\t\t\t\t\t<input type="range" id="Reference-Strength-${h}" name="Reference-Strength-${h}" min="0" max="50" value="30" style="flex-grow: 1;">\n\t\t\t\t\t\t\t\t\t<span id="Reference-Strength-value-${h}">0.60</span>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>`;e(".Vibe-img-container").append(u),e(document).on("input",`#slider-${h}`,function(){var t=e(this).val();e(`#slider-value-${h}`).text((t/50).toFixed(2)),informationExtracted[h]=t/50}),e(document).on("input",`#Reference-Strength-${h}`,function(){var t=e(this).val();e(`#Reference-Strength-value-${h}`).text((t/50).toFixed(2)),Reference_strength[h]=t/50}),e(`#${h} .demo-delete`).on("click",function(){delete imagesBase64[h],delete informationExtracted[h],delete Reference_strength[h];var t=e(this).data("id");e(`#${t}`).remove()})}})}})}),document.getElementById("fillBtn").addEventListener("click",processImage),document.addEventListener("DOMContentLoaded",function(){document.getElementById("remove_background").addEventListener("click",function(){let e={image_base64:uploadedImageBase64};var t=layer.load(2,{shade:[.1,"#fff"]});fetch("/api/remove_background",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then(e=>e.json()).then(e=>{e.mask_base64?(displayMask(e.mask_base64),layer.close(t)):(console.error("No mask received"),layer.close(t))}).catch(e=>{console.error("Error:",e),layer.close(t)})})}),layui.use(["upload"],function(){var e=layui.upload,t=layui.jquery,n=document.getElementById("expand-imageCanvas"),a=n.getContext("2d"),i=new Image,d=null,o=null,l=0,r={left:!0,right:!0,up:!0,down:!0};function c(){a.fillStyle="#808080",a.fillRect(0,0,n.width,n.height)}e.render({elem:"#expand-picture-drag",auto:!1,accept:"images",choose:function(e){e.preview(function(e,o,l){i.onload=function(){!function(e){let t=e.width,i=e.height;const o=(t=64*Math.floor(t/64))>4096?4096/t:1,l=(i=64*Math.floor(i/64))>4096?4096/i:1,r=Math.min(o,l);t=Math.floor(t*r),i=Math.floor(i*r),n.width=t,n.height=i,a.drawImage(e,0,0,t,i),d=a.getImageData(0,0,n.width,n.height)}(i),t("#expand-picture").show(),t("#ID-upload-demo-drag").addClass("layui-hide"),t("#Pro-upload-picture-drag").addClass("layui-hide"),t("#expand-picture-drag").addClass("layui-hide"),t("#expand-picture-container").removeClass("layui-hide"),c(),a.drawImage(i,0,0);var e=n.getBoundingClientRect();t(".img-canvas-container").css("height",e.height+"px")},i.src=l})}});document.getElementById("reset-button").addEventListener("click",function(){if(r.left=r.right=r.up=r.down=!0,d){n.width=d.width,n.height=d.height,a.putImageData(d,0,0),c(),a.drawImage(i,0,0),o=null,l=0;var e=n.getBoundingClientRect();t(".img-canvas-container").css("height",e.height+"px")}}),document.getElementById("upload-button").addEventListener("click",function(){d=a.getImageData(0,0,n.width,n.height),i.src=n.toDataURL(),r.left=r.right=r.up=r.down=!0,l=0,o=null}),document.getElementById("download-button").addEventListener("click",function(){var e=document.createElement("a");e.href=n.toDataURL(),e.download=Math.random().toString(36).substr(2,12)+".png",e.click()}),document.getElementById("delete-expand-picture-btn").addEventListener("click",function(){r.left=r.right=r.up=r.down=!0;var e=document.getElementById("expand-imageCanvas");e.getContext("2d").clearRect(0,0,e.width,e.height),t("#expand-picture").hide(),document.getElementById("mask-preview").innerHTML="",t("#expand-picture-drag").next('input[type="file"]').val(""),t("#ID-upload-demo-drag").removeClass("layui-hide"),t("#Pro-upload-picture-drag").removeClass("layui-hide"),t("#expand-picture-drag").removeClass("layui-hide"),t("#expand-picture-container").addClass("layui-hide"),expandImageBase64=null,expandMaskBase64=null,expand_width=0,expand_height=0}),document.getElementById("remove-button").addEventListener("click",function(){document.getElementById("mask-preview").innerHTML="",expandImageBase64=null,expandMaskBase64=null,expand_width=0,expand_height=0}),document.getElementById("export-button").addEventListener("click",function(){if(!o||0===l)return;const e=document.createElement("canvas"),t=e.getContext("2d"),a=document.createElement("canvas"),i=a.getContext("2d");let d=512-l,r=Number(document.getElementById("mask_diffusion").value);"left"===o||"right"===o?(e.width=a.width=512,e.height=a.height=n.height):(e.width=a.width=n.width,e.height=a.height=512),t.fillStyle=i.fillStyle="#FFFFFF",i.fillRect(0,0,a.width,a.height),i.fillStyle="#000000","left"===o?(t.fillRect(0,0,l,e.height),t.drawImage(n,l,0,n.width-l,n.height,l,0,n.width-l,e.height),i.fillRect(l+r,0,n.width-l,e.height)):"right"===o?(t.fillRect(d,0,l,e.height),t.drawImage(n,n.width-d-l,0,d,n.height,0,0,d,e.height),i.fillRect(0,0,d-r,e.height)):"up"===o?(t.fillRect(0,0,e.width,l),t.drawImage(n,0,l,n.width,d,0,l,n.width,d),i.fillRect(0,l+r,e.width,d)):"down"===o&&(t.fillRect(0,d,e.width,l),t.drawImage(n,0,n.height-d-l,n.width,d,0,0,n.width,d),i.fillRect(0,0,e.width,d-r)),document.getElementById("mask-preview").innerHTML="";const c=e.toDataURL("image/png");expandImageBase64=c.split(",")[1],expand_width=e.width,expand_height=e.height;const s=document.createElement("img");s.src=c,s.style.width="50px",s.style.height="50px",document.getElementById("mask-preview").appendChild(s);const h=a.toDataURL("image/png");expandMaskBase64=h.split(",")[1];const u=document.createElement("img");u.src=h,u.style.width="50px",u.style.height="50px",document.getElementById("mask-preview").appendChild(u)}),document.getElementById("fill-expand-Btn").addEventListener("click",function(){var e=document.querySelector("#img-display img");let t=512-l;if(e){var n=new Image;n.onload=function(){var e=document.getElementById("expand-imageCanvas"),a=e.getContext("2d");let c=0,s=0;switch(o){case"right":c=e.width-t-l,s=0;break;case"left":case"up":c=0,s=0;break;case"down":c=0,s=e.height-t-l}a.drawImage(n,c,s),r.left=r.right=r.up=r.down=!0,i.src=e.toDataURL(),d=a.getImageData(0,0,e.width,e.height),l=0},n.src=e.src}else alert("缺失填补图像")}),n.addEventListener("mousedown",function(e){var i=function(e,t){var n=e.getBoundingClientRect();return{x:(t.clientX-n.left)*(e.width/n.width),y:(t.clientY-n.top)*(e.height/n.height)}}(n,e);const d=i.x,s=i.y;let h;d>n.width-100&&r.right?h="right":d<100&&r.left?h="left":s>n.height-100&&r.down?h="down":s<100&&r.up&&(h="up"),h&&(!function(e){let t=n.width,i=n.height,d=0,o=0;switch(e){case"right":t+=64;break;case"left":t+=64,d=64;break;case"down":i+=64;break;case"up":i+=64,o=64}const l=a.getImageData(0,0,n.width,n.height);n.width=t,n.height=i,c(),a.putImageData(l,d,o),a.fillStyle="#FFFFFF","right"===e||"left"===e?a.fillRect("right"===e?n.width-64:0,0,64,n.height):a.fillRect(0,"down"===e?n.height-64:0,n.width,64)}(h),r.left=r.right=r.up=r.down=!1,r[h]=!0,o=h,l+=64);var u=n.getBoundingClientRect();t(".img-canvas-container").css("height",u.height+"px")})});